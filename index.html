<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>自己紹介カードジェネレーター（テンプレ＋アイコン調整）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- 和文フォント -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">

  <style>
    :root {
      /* デフォルトはモダン系 */
      --bg: #0f172a;
      --paper: #020617;
      --ink: #e5e7eb;
      --muted: #9ca3af;
      --accent: #2563eb;
      --accent-soft: #111827;
      --border: #374151;
    }

    /* 和風 */
    body[data-theme="wa"] {
      --bg: #f5f0e6;
      --paper: #fffaf0;
      --ink: #3b2f2f;
      --muted: #8b6b4a;
      --accent: #c05621;
      --accent-soft: #f6e2c3;
      --border: #e2c999;
    }

    /* 楓（オータム和風） */
    body[data-theme="kaede"] {
      --bg: #f9f3ea;
      --paper: #fffaf5;
      --ink: #3b2f2f;
      --muted: #9b6b4b;
      --accent: #d97745;
      --accent-soft: #fde7cf;
      --border: #f1c9a5;
    }

    /* モダン（西洋） */
    body[data-theme="western"] {
      --bg: #0f172a;
      --paper: #020617;
      --ink: #e5e7eb;
      --muted: #9ca3af;
      --accent: #2563eb;
      --accent-soft: #111827;
      --border: #374151;
    }

    /* 日の丸 */
    body[data-theme="hinomaru"] {
      --bg: #f9fafb;
      --paper: #ffffff;
      --ink: #111827;
      --muted: #6b7280;
      --accent: #dc2626;
      --accent-soft: #fee2e2;
      --border: #e5e7eb;
    }

    /* 単色・ダブルカラーは白背景ベース（モダンレイアウトで使う） */
    body[data-theme="solid"],
    body[data-theme="dual"] {
      --bg: #f5f5f5;
      --paper: #ffffff;
      --ink: #111827;
      --muted: #6b7280;
      --accent: #2563eb;      /* JSで上書きされる */
      --accent-soft: #e5e7eb;
      --border: #e5e7eb;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      font-family: "Noto Sans JP", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--ink);
      background: var(--bg);
      transition: background 0.25s ease;
    }

    .app {
      max-width: 1000px;
      width: 100%;
      background: var(--paper);
      border-radius: 18px;
      border: 1px solid var(--border);
      box-shadow:
        0 14px 35px rgba(0, 0, 0, 0.35),
        0 0 0 2px rgba(0, 0, 0, 0.4);
      display: grid;
      grid-template-columns: 1.1fr 1fr;
      gap: 20px;
      padding: 18px 20px;
      position: relative;
      overflow: hidden;
      transition: background 0.25s ease, border-color 0.25s ease, box-shadow 0.25s ease;
    }

    @media (max-width: 840px) {
      .app {
        grid-template-columns: 1fr;
        padding: 14px;
        box-shadow:
          0 10px 28px rgba(0, 0, 0, 0.45),
          0 0 0 1px rgba(0, 0, 0, 0.5);
      }
    }

    .app-inner {
      position: relative;
      z-index: 1;
      display: contents;
    }

    h1 {
      font-size: 20px;
      margin: 0 0 4px;
      letter-spacing: 0.08em;
      color: var(--ink);
    }

    .subtitle {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 10px;
    }

    .section-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--accent);
      margin: 10px 0 6px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .section-title::before {
      content: "";
      width: 14px;
      height: 1px;
      background: var(--accent);
    }

    label {
      display: block;
      font-size: 11px;
      margin-bottom: 3px;
      color: var(--muted);
    }

    .field { margin-bottom: 8px; }

    input[type="text"],
    textarea,
    select {
      width: 100%;
      padding: 7px 9px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(0, 0, 0, 0.05);
      font-size: 13px;
      color: var(--ink);
      outline: none;
      transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
    }

    input[type="text"]:focus,
    textarea:focus,
    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.2);
      background: rgba(0, 0, 0, 0.02);
    }

    textarea {
      resize: vertical;
      min-height: 60px;
    }

    input[type="file"] {
      font-size: 11px;
      color: var(--muted);
    }

    .inline-group {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .checkbox-label {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      color: var(--muted);
      cursor: pointer;
      user-select: none;
    }

    .checkbox-label input { accent-color: var(--accent); }

    button {
      padding: 9px 16px;
      border-radius: 999px;
      border: none;
      background: var(--accent);
      color: #ffffff;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      margin-top: 10px;
      letter-spacing: 0.08em;
      transition: filter 0.15s ease, transform 0.15s ease, background 0.2s ease;
    }

    button:hover { filter: brightness(1.05); }
    button:active { transform: translateY(1px); }

    .hint {
      font-size: 10px;
      color: var(--muted);
      margin-top: 3px;
      line-height: 1.4;
    }

    .preview-box {
      background: var(--accent-soft);
      border-radius: 14px;
      padding: 10px;
      border: 1px dashed var(--border);
      text-align: center;
      backdrop-filter: blur(3px);
    }

    .preview-caption {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 4px;
    }

    #facePreview {
      width: 110px;
      height: 110px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--border);
      margin-bottom: 6px;
      background: rgba(255, 255, 255, 0.08);
    }

    canvas {
      width: 100%;
      border-radius: 12px;
      margin-top: 8px;
      background: #000;
    }

    a.hidden { display: none; }

    .gender-group {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 12px;
    }

    .gender-group label {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      color: var(--ink);
      font-size: 12px;
      margin-bottom: 0;
    }

    .gender-group input { accent-color: var(--accent); }

    .age-select {
      flex: 1;
      min-width: 100px;
    }

    .location-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    @media (min-width: 560px) {
      .location-row {
        flex-direction: row;
        align-items: center;
      }
      .location-row input[type="text"] { flex: 1; }
    }

    .theme-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .color-input-wrapper {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      color: var(--muted);
    }

    .color-input-wrapper input[type="color"] {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 0;
      background: transparent;
      cursor: pointer;
    }

    .slider-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 11px;
      color: var(--muted);
    }

    .slider-label-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .slider-value {
      font-size: 11px;
      color: var(--accent);
      font-weight: 600;
    }

    input[type="range"] { width: 100%; }

    @media (max-width: 480px) {
      h1 { font-size: 18px; }
      button {
        width: 100%;
        justify-content: center;
        display: inline-flex;
      }
    }
  </style>
</head>
<body data-theme="wa">
  <div class="app">
    <div class="app-inner">
      <!-- 左：入力エリア -->
      <div>
        <h1>自己紹介カードジェネレーター</h1>
        <div class="subtitle">テンプレとアイコン位置を調整して、あなただけのプロフィール画像を作成。</div>

        <div class="section-title">テンプレート・テーマ</div>

        <div class="field">
          <label for="themeSelect">デザインテーマ</label>
          <div class="theme-row">
            <select id="themeSelect">
              <option value="wa">和風</option>
              <option value="kaede">楓（オータム和風）</option>
              <option value="western">モダン</option>
              <option value="hinomaru">日の丸</option>
              <option value="solid">単色カラー（モダンレイアウト）</option>
              <option value="dual">ダブルカラー（モダンレイアウト）</option>
            </select>

            <div class="color-input-wrapper">
              <span>色１</span>
              <input type="color" id="color1" value="#2563eb">
            </div>
            <div class="color-input-wrapper">
              <span>色２</span>
              <input type="color" id="color2" value="#0f172a">
            </div>
          </div>
          <div class="hint">
            ・和風 / 楓 / モダン / 日の丸はデザイン固定<br>
            ・単色 / ダブルカラーは「モダンレイアウト」で、色１・色２だけ変えられます
          </div>
        </div>

        <div class="section-title">アイコン画像</div>

        <div class="field">
          <label for="iconInput">アイコン画像のアップロード</label>
          <input id="iconInput" type="file" accept="image/*">
          <div class="hint">※ 顔写真でもイラストでもOK。画像はブラウザ内だけで使用されます。</div>
        </div>

        <!-- アイコン位置&サイズ調整 -->
        <div class="field">
          <div class="slider-row">
            <div class="slider-label-row">
              <span>アイコン位置（横）</span>
              <span class="slider-value">X: <span id="iconPosXValue">0</span></span>
            </div>
            <input type="range" id="iconPosX" min="-150" max="150" value="0">
          </div>
        </div>
        <div class="field">
          <div class="slider-row">
            <div class="slider-label-row">
              <span>アイコン位置（縦）</span>
              <span class="slider-value">Y: <span id="iconPosYValue">0</span></span>
            </div>
            <input type="range" id="iconPosY" min="-150" max="150" value="0">
          </div>
        </div>
        <div class="field">
          <div class="slider-row">
            <div class="slider-label-row">
              <span>アイコン拡大（50〜150％）</span>
              <span class="slider-value">拡大: <span id="iconScaleValue">100</span>%</span>
            </div>
            <input type="range" id="iconScale" min="50" max="150" value="100">
          </div>
          <div class="hint">※ 画像の縦横比は保ったまま拡大・縮小されるので、歪みません。</div>
        </div>

        <div class="section-title">基本情報</div>

        <div class="field">
          <label for="nicknameInput">ニックネーム</label>
          <input id="nicknameInput" type="text" placeholder="例：山内正樹/ やまさん／うっちー">
        </div>

        <div class="field">
          <label>年齢</label>
          <div class="inline-group">
            <select id="ageSelect" class="age-select"></select>
            <label class="checkbox-label">
              <input type="checkbox" id="ageHidden">
              年齢を非公開にする
            </label>
          </div>
        </div>

        <div class="field">
          <label>性別</label>
          <div class="gender-group">
            <label><input type="radio" name="gender" value="男性" checked>男性</label>
            <label><input type="radio" name="gender" value="女性">女性</label>
            <label><input type="radio" name="gender" value="その他">その他</label>
            <label><input type="radio" name="gender" value="ひみつ">ひみつ</label>
          </div>
        </div>

        <div class="field">
          <label>住んでいる場所</label>
          <div class="location-row">
            <input id="locationInput" type="text" placeholder="例：東京 / 関東 / 関西 など">
            <label class="checkbox-label">
              <input type="checkbox" id="locationHidden">
              場所を非公開にする
            </label>
          </div>
        </div>

        <div class="section-title">趣味・ゲーム</div>

        <div class="field">
          <label for="hobbyInput">趣味</label>
          <textarea id="hobbyInput" placeholder="例：漫画、ゲーム、散歩、写真を撮ること など"></textarea>
        </div>

        <div class="field">
          <label for="gameInput">やっているゲーム</label>
          <textarea id="gameInput" placeholder="例：原神、スプラ、APEX、音ゲー など"></textarea>
        </div>

        <div class="section-title">みんなにひとこと</div>

        <div class="field">
          <label for="messageInput">ひとことメッセージ</label>
          <textarea id="messageInput" placeholder="例：気軽に話しかけてくれるとうれしいです！"></textarea>
        </div>

        <button id="generateBtn">自己紹介画像をつくる（自動ダウンロード）</button>
        <a id="downloadLink" class="hidden">ダウンロード</a>
        <div class="hint">
          ※ 生成されるのは PNG 画像です。SNS や自己紹介スライドなどにそのまま貼れます。
        </div>
      </div>

      <!-- 右：プレビュー＆キャンバス -->
      <div class="preview-box">
        <div class="preview-caption">プレビュー（テーマとアイコン位置に応じて変わります）</div>
        <img id="facePreview" src="" alt="アイコンのプレビュー">
        <canvas id="cardCanvas" width="800" height="450"></canvas>
        <div class="hint">※ 実際にダウンロードされる画像は、このキャンバスの内容です。</div>
      </div>
    </div>
  </div>

  <script>
    const iconInput = document.getElementById('iconInput');
    const facePreview = document.getElementById('facePreview');
    const generateBtn = document.getElementById('generateBtn');
    const downloadLink = document.getElementById('downloadLink');
    const canvas = document.getElementById('cardCanvas');
    const ctx = canvas.getContext('2d');
    const ageSelect = document.getElementById('ageSelect');
    const themeSelect = document.getElementById('themeSelect');
    const color1Input = document.getElementById('color1');
    const color2Input = document.getElementById('color2');

    const iconPosXInput = document.getElementById('iconPosX');
    const iconPosYInput = document.getElementById('iconPosY');
    const iconScaleInput = document.getElementById('iconScale');
    const iconPosXValue = document.getElementById('iconPosXValue');
    const iconPosYValue = document.getElementById('iconPosYValue');
    const iconScaleValue = document.getElementById('iconScaleValue');

    let uploadedImg = null;

    // 年齢プルダウン（10〜80歳）
    (function fillAgeSelect() {
      const placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.textContent = '選択してください';
      ageSelect.appendChild(placeholder);

      for (let i = 10; i <= 80; i++) {
        const opt = document.createElement('option');
        opt.value = String(i);
        opt.textContent = i + '歳';
        ageSelect.appendChild(opt);
      }
    })();

    function updateIconLabels() {
      iconPosXValue.textContent = iconPosXInput.value;
      iconPosYValue.textContent = iconPosYInput.value;
      iconScaleValue.textContent = iconScaleInput.value;
    }

    // アイコン画像アップロード → プレビュー表示
    iconInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (ev) => {
        const img = new Image();
        img.onload = () => {
          uploadedImg = img;
          facePreview.src = img.src;
          drawIntroCard();
        };
        img.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    });

    // テーマ選択 → ページ全体の色も切り替え
    themeSelect.addEventListener('change', () => {
      const theme = themeSelect.value;
      document.body.setAttribute('data-theme', theme);
      applyCustomColors();
      drawIntroCard();
    });

    color1Input.addEventListener('input', () => {
      applyCustomColors();
      drawIntroCard();
    });
    color2Input.addEventListener('input', () => {
      applyCustomColors();
      drawIntroCard();
    });

    function applyCustomColors() {
      const theme = themeSelect.value;
      const c1 = color1Input.value;
      const c2 = color2Input.value;

      if (theme === 'solid' || theme === 'dual') {
        document.body.style.setProperty('--accent', c1);
        document.body.style.setProperty('--accent-soft', '#e5e7eb');
        document.body.style.setProperty('--bg', '#f5f5f5');
        document.body.style.setProperty('--paper', '#ffffff');
        document.body.style.setProperty('--border', '#e5e7eb');
      } else {
        document.body.style.removeProperty('--accent');
        document.body.style.removeProperty('--accent-soft');
        document.body.style.removeProperty('--bg');
        document.body.style.removeProperty('--paper');
        document.body.style.removeProperty('--border');
      }
    }

    // 日本語用ざっくり折り返し
    function wrapTextJP(text, maxChars, maxLines) {
      if (!text) return [];
      const lines = [];
      let current = '';

      for (let i = 0; i < text.length; i++) {
        current += text[i];
        if (current.length >= maxChars || i === text.length - 1) {
          lines.push(current);
          current = '';
        }
        if (maxLines && lines.length >= maxLines) break;
      }
      return lines;
    }

    function getFormValues() {
      const nickname = document.getElementById('nicknameInput').value || 'ななしさん';
      const ageValue = ageSelect.value;
      const ageHidden = document.getElementById('ageHidden').checked;
      const locationValue = document.getElementById('locationInput').value || '';
           const locationHidden = document.getElementById('locationHidden').checked;
      const hobby = document.getElementById('hobbyInput').value;
      const game = document.getElementById('gameInput').value;
      const message = document.getElementById('messageInput').value;

      const genderNode = document.querySelector('input[name="gender"]:checked');
      const gender = genderNode ? genderNode.value : 'ひみつ';

      let ageText;
      if (ageHidden) {
        ageText = '年齢：ひみつ';
      } else if (ageValue) {
        ageText = '年齢：' + ageValue + '歳';
      } else {
        ageText = '年齢：未設定';
      }

      let locText;
      if (locationHidden) {
        locText = '住んでいる場所：ひみつ';
      } else if (locationValue.trim().length > 0) {
        locText = '住んでいる場所：' + locationValue.trim();
      } else {
        locText = '住んでいる場所：未設定';
      }

      return { nickname, ageText, gender, locText, hobby, game, message };
    }

    function getIconOptions() {
      const offsetX = parseInt(iconPosXInput.value || '0', 10);
      const offsetY = parseInt(iconPosYInput.value || '0', 10);
      const scalePercent = parseInt(iconScaleInput.value || '100', 10);
      const scale = scalePercent / 100;
      return { offsetX, offsetY, scale };
    }

    /* 共通：アイコン描画（アスペクト比維持） */
    function drawCommonIcon(centerX, centerY, radius, placeholderStyle, iconOpts) {
      const offsetX = iconOpts?.offsetX || 0;
      const offsetY = iconOpts?.offsetY || 0;
      const userScale = iconOpts?.scale || 1;

      ctx.save();
      ctx.beginPath();
      ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
      ctx.closePath();
      ctx.clip();

      if (uploadedImg) {
        const iw = uploadedImg.width;
        const ih = uploadedImg.height;

        const baseScale = Math.min((radius * 2) / iw, (radius * 2) / ih);
        const s = baseScale * userScale;

        const drawW = iw * s;
        const drawH = ih * s;

        const dx = centerX - drawW / 2 + offsetX;
        const dy = centerY - drawH / 2 + offsetY;

        ctx.drawImage(uploadedImg, dx, dy, drawW, drawH);
      } else {
        ctx.fillStyle = placeholderStyle.bg;
        ctx.fillRect(centerX - radius, centerY - radius, radius * 2, radius * 2);
        ctx.fillStyle = placeholderStyle.fg;
        ctx.font = placeholderStyle.font;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(placeholderStyle.text, centerX, centerY);
      }

      ctx.restore();

      ctx.beginPath();
      ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
      ctx.strokeStyle = placeholderStyle.border;
      ctx.lineWidth = 4;
      ctx.stroke();
    }

    /* 和風（固定色） */
    function drawWaTheme(values, iconOpts) {
      const W = canvas.width;
      const H = canvas.height;

      const bgGrad = ctx.createLinearGradient(0, 0, W, H);
      bgGrad.addColorStop(0, '#f8f0de');
      bgGrad.addColorStop(1, '#f0dfc4');
      ctx.fillStyle = bgGrad;
      ctx.fillRect(0, 0, W, H);

      ctx.strokeStyle = '#d2b48c';
      ctx.lineWidth = 8;
      ctx.strokeRect(10, 10, W - 20, H - 20);

      ctx.fillStyle = '#fff8e8';
      ctx.fillRect(26, 26, W - 52, H - 52);

      drawCommonIcon(160, 165, 90, {
        bg: '#e5d5ba',
        fg: '#9a7b54',
        font: 'bold 26px "Noto Sans JP", system-ui',
        text: 'No Image',
        border: '#c56a32'
      }, iconOpts);

      ctx.fillStyle = '#f6e2c3';
      ctx.fillRect(280, 40, W - 340, 46);
      ctx.fillStyle = '#c05621';
      ctx.font = 'bold 22px "Noto Sans JP", system-ui';
      ctx.textAlign = 'left';
      ctx.textBaseline = 'middle';
      ctx.fillText('自己紹介', 300, 63);

      ctx.fillStyle = '#3b2f2f';
      ctx.font = 'bold 34px "Noto Sans JP", system-ui';
      ctx.fillText(values.nickname, 280, 120);

      ctx.fillStyle = '#8b5e34';
      ctx.font = '14px "Noto Sans JP", system-ui';
      ctx.fillText('基本情報', 280, 150);

      ctx.fillStyle = '#3b2f2f';
      ctx.font = '16px "Noto Sans JP", system-ui';

      const baseY = 178;
      const lineH = 26;

      ctx.fillText(values.ageText, 280, baseY);
      ctx.fillText('性別：' + values.gender, 280, baseY + lineH);
      ctx.fillText(values.locText, 280, baseY + lineH * 2);

      ctx.strokeStyle = '#e0c89e';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(280, baseY + lineH * 2 + 12);
      ctx.lineTo(W - 40, baseY + lineH * 2 + 12);
      ctx.stroke();

      let textY = baseY + lineH * 2 + 36;

      ctx.fillStyle = '#8b5e34';
      ctx.font = '14px "Noto Sans JP", system-ui';
      ctx.fillText('趣味', 280, textY);
      ctx.fillStyle = '#3b2f2f';
      ctx.font = '15px "Noto Sans JP", system-ui';

      const hobbyLines = wrapTextJP(values.hobby || '未入力', 18, 2);
      hobbyLines.forEach((line, i) => {
        ctx.fillText('・' + line, 280, textY + 22 + i * 22);
      });

      textY += 22 * (Math.max(hobbyLines.length, 1) + 1) + 6;

      ctx.fillStyle = '#8b5e34';
      ctx.font = '14px "Noto Sans JP", system-ui';
      ctx.fillText('やっているゲーム', 280, textY);
      ctx.fillStyle = '#3b2f2f';
      ctx.font = '15px "Noto Sans JP", system-ui';

      const gameLines = wrapTextJP(values.game || '未入力', 18, 2);
      gameLines.forEach((line, i) => {
        ctx.fillText('・' + line, 280, textY + 22 + i * 22);
      });

      textY += 22 * (Math.max(gameLines.length, 1) + 1) + 6;

      ctx.fillStyle = '#8b5e34';
      ctx.font = '14px "Noto Sans JP", system-ui';
      ctx.fillText('みんなにひとこと', 280, textY);
      ctx.fillStyle = '#3b2f2f';
      ctx.font = '15px "Noto Sans JP", system-ui';

      const msgLines = wrapTextJP(values.message || 'よろしくお願いします！', 18, 2);
      msgLines.forEach((line, i) => {
        ctx.fillText('「' + line + (i === msgLines.length - 1 ? '」' : ''), 280, textY + 22 + i * 22);
      });

      ctx.fillStyle = '#b08a5b';
      ctx.font = '11px "Noto Sans JP", system-ui';
      ctx.textAlign = 'right';
      ctx.fillText('和風・自己紹介カード', W - 36, H - 30);
    }

    /* 楓（オータム和風） */
    function drawKaedeTheme(values, iconOpts) {
      const W = canvas.width;
      const H = canvas.height;

      const bgGrad = ctx.createLinearGradient(0, 0, W, H);
      bgGrad.addColorStop(0, '#fff7ec');
      bgGrad.addColorStop(0.5, '#fde0c2');
      bgGrad.addColorStop(1, '#f8b4a1');
      ctx.fillStyle = bgGrad;
      ctx.fillRect(0, 0, W, H);

      ctx.strokeStyle = '#f1c9a5';
      ctx.lineWidth = 8;
      ctx.strokeRect(10, 10, W - 20, H - 20);

      ctx.fillStyle = '#fffaf5';
      ctx.fillRect(26, 26, W - 52, H - 52);

      ctx.fillStyle = '#f97316';
      ctx.fillRect(40, 40, 40, H - 80);
      ctx.fillStyle = '#ea580c';
      ctx.fillRect(50, 40, 8, H - 80);

      drawCommonIcon(160, 165, 90, {
        bg: '#fde7cf',
        fg: '#9b6b4b',
        font: 'bold 26px "Noto Sans JP", system-ui',
        text: 'No Image',
        border: '#ea580c'
      }, iconOpts);

      ctx.fillStyle = '#f97316';
      ctx.fillRect(280, 40, W - 340, 46);
      ctx.fillStyle = '#fff7ed';
      ctx.font = 'bold 22px "Noto Sans JP", system-ui';
      ctx.textAlign = 'left';
      ctx.textBaseline = 'middle';
      ctx.fillText('自己紹介 - 楓', 300, 63);

      ctx.fillStyle = '#3b2f2f';
      ctx.font = 'bold 34px "Noto Sans JP", system-ui';
      ctx.fillText(values.nickname, 280, 120);

      ctx.fillStyle = '#d97745';
      ctx.font = '14px "Noto Sans JP", system-ui';
      ctx.fillText('基本情報', 280, 150);

      ctx.fillStyle = '#3b2f2f';
      ctx.font = '16px "Noto Sans JP", system-ui';

      const baseY = 178;
      const lineH = 26;

      ctx.fillText(values.ageText, 280, baseY);
      ctx.fillText('性別：' + values.gender, 280, baseY + lineH);
      ctx.fillText(values.locText, 280, baseY + lineH * 2);

      ctx.strokeStyle = '#f1c9a5';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(280, baseY + lineH * 2 + 12);
      ctx.lineTo(W - 40, baseY + lineH * 2 + 12);
      ctx.stroke();

      let textY = baseY + lineH * 2 + 36;

      ctx.fillStyle = '#d97745';
      ctx.font = '14px "Noto Sans JP", system-ui';
      ctx.fillText('趣味', 280, textY);
      ctx.fillStyle = '#3b2f2f';
      ctx.font = '15px "Noto Sans JP", system-ui';

      const hobbyLines = wrapTextJP(values.hobby || '未入力', 18, 2);
      hobbyLines.forEach((line, i) => {
        ctx.fillText('・' + line, 280, textY + 22 + i * 22);
      });

      textY += 22 * (Math.max(hobbyLines.length, 1) + 1) + 6;

      ctx.fillStyle = '#d97745';
      ctx.font = '14px "Noto Sans JP", system-ui';
      ctx.fillText('やっているゲーム', 280, textY);
      ctx.fillStyle = '#3b2f2f';
      ctx.font = '15px "Noto Sans JP", system-ui';

      const gameLines = wrapTextJP(values.game || '未入力', 18, 2);
      gameLines.forEach((line, i) => {
        ctx.fillText('・' + line, 280, textY + 22 + i * 22);
      });

      textY += 22 * (Math.max(gameLines.length, 1) + 1) + 6;

      ctx.fillStyle = '#d97745';
      ctx.font = '14px "Noto Sans JP", system-ui';
      ctx.fillText('みんなにひとこと', 280, textY);
      ctx.fillStyle = '#3b2f2f';
      ctx.font = '15px "Noto Sans JP", system-ui';

      const msgLines = wrapTextJP(values.message || 'よろしくお願いします！', 18, 2);
      msgLines.forEach((line, i) => {
        ctx.fillText('「' + line + (i === msgLines.length - 1 ? '」' : ''), 280, textY + 22 + i * 22);
      });

      ctx.fillStyle = '#9b6b4b';
      ctx.font = '11px "Noto Sans JP", system-ui';
      ctx.textAlign = 'right';
      ctx.fillText('楓・オータム和風カード', W - 36, H - 30);
    }

    /* モダン（元の固定色版） */
    function drawWesternTheme(values, iconOpts) {
      const W = canvas.width;
      const H = canvas.height;

      const bgGrad = ctx.createLinearGradient(0, 0, W, H);
      bgGrad.addColorStop(0, '#020617');
      bgGrad.addColorStop(1, '#020617');
      ctx.fillStyle = bgGrad;
      ctx.fillRect(0, 0, W, H);

      ctx.fillStyle = '#0b1120';
      ctx.fillRect(24, 24, W - 48, H - 48);

      const decoGrad = ctx.createLinearGradient(24, 24, W, H);
      decoGrad.addColorStop(0, 'rgba(59,130,246,0.35)');
      decoGrad.addColorStop(1, 'rgba(56,189,248,0.1)');
      ctx.fillStyle = decoGrad;
      ctx.fillRect(24, 24, W - 48, H - 48);

      drawCommonIcon(160, 165, 90, {
        bg: '#020617',
        fg: '#4b5563',
        font: 'bold 20px "Noto Sans JP", system-ui',
        text: 'No Image',
        border: '#3b82f6'
      }, iconOpts);

      ctx.fillStyle = '#111827';
      ctx.fillRect(280, 40, W - 320, 40);
      ctx.fillStyle = '#60a5fa';
      ctx.font = 'bold 18px "Noto Sans JP", system-ui';
      ctx.textAlign = 'left';
      ctx.textBaseline = 'middle';
      ctx.fillText('SELF INTRODUCTION', 292, 60);

      ctx.fillStyle = '#e5e7eb';
      ctx.font = 'bold 32px "Noto Sans JP", system-ui';
      ctx.fillText(values.nickname, 280, 120);

      ctx.fillStyle = '#9ca3af';
      ctx.font = '14px "Noto Sans JP", system-ui';
      ctx.fillText('BASIC INFO', 280, 148);

      ctx.fillStyle = '#e5e7eb';
      ctx.font = '16px "Noto Sans JP", system-ui';

      const baseY = 175;
      const lineH = 24;
      ctx.fillText(values.ageText, 280, baseY);
      ctx.fillText('性別：' + values.gender, 280, baseY + lineH);
      ctx.fillText(values.locText, 280, baseY + lineH * 2);

      ctx.strokeStyle = 'rgba(148,163,184,0.5)';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(280, baseY + lineH * 2 + 12);
      ctx.lineTo(W - 40, baseY + lineH * 2 + 12);
      ctx.stroke();

      let textY = baseY + lineH * 2 + 34;

      ctx.fillStyle = '#9ca3af';
      ctx.font = '13px "Noto Sans JP", system-ui';
      ctx.fillText('HOBBIES', 280, textY);
      ctx.fillStyle = '#e5e7eb';
      ctx.font = '15px "Noto Sans JP", system-ui';

      const hobbyLines = wrapTextJP(values.hobby || '未入力', 20, 2);
      hobbyLines.forEach((line, i) => {
        ctx.fillText('・' + line, 280, textY + 22 + i * 22);
      });

      textY += 22 * (Math.max(hobbyLines.length, 1) + 1) + 6;

      ctx.fillStyle = '#9ca3af';
      ctx.font = '13px "Noto Sans JP", system-ui';
      ctx.fillText('GAMES', 280, textY);
      ctx.fillStyle = '#e5e7eb';
      ctx.font = '15px "Noto Sans JP", system-ui';

      const gameLines = wrapTextJP(values.game || '未入力', 20, 2);
      gameLines.forEach((line, i) => {
        ctx.fillText('・' + line, 280, textY + 22 + i * 22);
      });

      textY += 22 * (Math.max(gameLines.length, 1) + 1) + 6;

      ctx.fillStyle = '#9ca3af';
      ctx.font = '13px "Noto Sans JP", system-ui';
      ctx.fillText('MESSAGE', 280, textY);
      ctx.fillStyle = '#e5e7eb';
      ctx.font = '15px "Noto Sans JP", system-ui';

      const msgLines = wrapTextJP(values.message || 'Nice to meet you!', 20, 2);
      msgLines.forEach((line, i) => {
        ctx.fillText(line, 280, textY + 22 + i * 22);
      });

      ctx.fillStyle = '#6b7280';
      ctx.font = '11px "Noto Sans JP", system-ui';
      ctx.textAlign = 'right';
      ctx.fillText('Modern Profile Card', W - 36, H - 28);
    }

    /* モダンレイアウト＋色カスタム（単色・ダブル用） */
    function drawModernColorTheme(values, iconOpts, c1, c2) {
      const W = canvas.width;
      const H = canvas.height;

      const bgGrad = ctx.createLinearGradient(0, 0, W, H);
      const bgAccent = c2 || '#e5e7eb';
      bgGrad.addColorStop(0, '#f9fafb');
      bgGrad.addColorStop(1, bgAccent);
      ctx.fillStyle = bgGrad;
      ctx.fillRect(0, 0, W, H);

      ctx.fillStyle = '#ffffff';
      ctx.fillRect(24, 24, W - 48, H - 48);

      const decoGrad = ctx.createLinearGradient(24, 24, W, H);
      decoGrad.addColorStop(0, c1 + '55'); // 透過気味
      decoGrad.addColorStop(1, bgAccent + '22');
      ctx.fillStyle = decoGrad;
      ctx.fillRect(24, 24, W - 48, H - 48);

      drawCommonIcon(160, 165, 90, {
        bg: '#e5e7eb',
        fg: '#6b7280',
        font: 'bold 20px "Noto Sans JP", system-ui',
        text: 'No Image',
        border: c1
      }, iconOpts);

      ctx.fillStyle = '#ffffff';
      ctx.fillRect(280, 40, W - 320, 40);
      ctx.fillStyle = c1;
      ctx.font = 'bold 18px "Noto Sans JP", system-ui';
      ctx.textAlign = 'left';
      ctx.textBaseline = 'middle';
      ctx.fillText('SELF INTRODUCTION', 292, 60);

      ctx.fillStyle = '#111827';
      ctx.font = 'bold 32px "Noto Sans JP", system-ui';
      ctx.fillText(values.nickname, 280, 120);

      ctx.fillStyle = c1;
      ctx.font = '14px "Noto Sans JP", system-ui';
      ctx.fillText('BASIC INFO', 280, 148);

      ctx.fillStyle = '#111827';
      ctx.font = '16px "Noto Sans JP", system-ui';

      const baseY = 175;
      const lineH = 24;
      ctx.fillText(values.ageText, 280, baseY);
      ctx.fillText('性別：' + values.gender, 280, baseY + lineH);
      ctx.fillText(values.locText, 280, baseY + lineH * 2);

      ctx.strokeStyle = '#e5e7eb';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(280, baseY + lineH * 2 + 12);
      ctx.lineTo(W - 40, baseY + lineH * 2 + 12);
      ctx.stroke();

      let textY = baseY + lineH * 2 + 34;

      ctx.fillStyle = c1;
      ctx.font = '13px "Noto Sans JP", system-ui';
      ctx.fillText('HOBBIES', 280, textY);
      ctx.fillStyle = '#111827';
      ctx.font = '15px "Noto Sans JP", system-ui';

      const hobbyLines = wrapTextJP(values.hobby || '未入力', 20, 2);
      hobbyLines.forEach((line, i) => {
        ctx.fillText('・' + line, 280, textY + 22 + i * 22);
      });

      textY += 22 * (Math.max(hobbyLines.length, 1) + 1) + 6;

      ctx.fillStyle = c1;
      ctx.font = '13px "Noto Sans JP", system-ui';
      ctx.fillText('GAMES', 280, textY);
      ctx.fillStyle = '#111827';
      ctx.font = '15px "Noto Sans JP", system-ui';

      const gameLines = wrapTextJP(values.game || '未入力', 20, 2);
      gameLines.forEach((line, i) => {
        ctx.fillText('・' + line, 280, textY + 22 + i * 22);
      });

      textY += 22 * (Math.max(gameLines.length, 1) + 1) + 6;

      ctx.fillStyle = c1;
      ctx.font = '13px "Noto Sans JP", system-ui';
      ctx.fillText('MESSAGE', 280, textY);
      ctx.fillStyle = '#111827';
      ctx.font = '15px "Noto Sans JP", system-ui';

      const msgLines = wrapTextJP(values.message || 'Nice to meet you!', 20, 2);
      msgLines.forEach((line, i) => {
        ctx.fillText(line, 280, textY + 22 + i * 22);
      });

      ctx.fillStyle = '#6b7280';
      ctx.font = '11px "Noto Sans JP", system-ui';
      ctx.textAlign = 'right';
      ctx.fillText('Custom Modern Intro Card', W - 36, H - 28);
    }

    /* 日の丸 */
    function drawHinomaruTheme(values, iconOpts) {
      const W = canvas.width;
      const H = canvas.height;

      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, W, H);

      ctx.fillStyle = '#dc2626';
      ctx.beginPath();
      ctx.arc(W / 2, H / 2 - 30, 120, 0, Math.PI * 2);
      ctx.fill();

      drawCommonIcon(W / 2, H / 2 - 30, 70, {
        bg: '#ffffff',
        fg: '#9ca3af',
        font: 'bold 18px "Noto Sans JP", system-ui',
        text: 'No Image',
        border: '#fee2e2'
      }, iconOpts);

      ctx.fillStyle = '#111827';
      ctx.font = 'bold 32px "Noto Sans JP", system-ui';
      ctx.textAlign = 'center';
      ctx.fillText(values.nickname, W / 2, H - 150);

      ctx.fillStyle = '#4b5563';
      ctx.font = '15px "Noto Sans JP", system-ui';

      const lines = [values.ageText, '性別：' + values.gender, values.locText];
      lines.forEach((t, i) => {
        ctx.fillText(t, W / 2, H - 120 + i * 20);
      });

      ctx.fillStyle = '#1f2933';
      ctx.font = '14px "Noto Sans JP", system-ui';
      const hobbyLine = '趣味：' + (values.hobby ? values.hobby.replace(/\s+/g, ' ').slice(0, 26) + (values.hobby.length > 26 ? '…' : '') : '未入力');
      const gameLine = 'ゲーム：' + (values.game ? values.game.replace(/\s+/g, ' ').slice(0, 26) + (values.game.length > 26 ? '…' : '') : '未入力');
      ctx.fillText(hobbyLine, W / 2, H - 58);
      ctx.fillText(gameLine, W / 2, H - 36);

      ctx.fillStyle = '#dc2626';
      ctx.font = '14px "Noto Sans JP", system-ui';
      const msg = values.message || 'よろしくお願いします！';
      ctx.fillText('「' + msg.slice(0, 24) + (msg.length > 24 ? '…' : '') + '」', W / 2, H - 12);

      ctx.fillStyle = '#9ca3af';
      ctx.font = '10px "Noto Sans JP", system-ui';
      ctx.textAlign = 'right';
      ctx.fillText('Hinomaru Style Intro Card', W - 16, 18);
    }

    /* メイン描画 */
    function drawIntroCard() {
      const W = 800;
      const H = 450;
      canvas.width = W;
      canvas.height = H;

      const values = getFormValues();
      const theme = themeSelect.value;
      const c1 = color1Input.value;
      const c2 = color2Input.value;
      const iconOpts = getIconOptions();

      if (theme === 'wa') {
        drawWaTheme(values, iconOpts);
      } else if (theme === 'kaede') {
        drawKaedeTheme(values, iconOpts);
      } else if (theme === 'western') {
        drawWesternTheme(values, iconOpts);
      } else if (theme === 'hinomaru') {
        drawHinomaruTheme(values, iconOpts);
      } else if (theme === 'solid') {
        // 単色（モダンレイアウト）
        drawModernColorTheme(values, iconOpts, c1, null);
      } else if (theme === 'dual') {
        // ダブルカラー（モダンレイアウト）
        drawModernColorTheme(values, iconOpts, c1, c2);
      }
    }

    // 初期描画＆ラベル
    drawIntroCard();
    applyCustomColors();
    updateIconLabels();

    // ボタン → 描画 & ダウンロード
    generateBtn.addEventListener('click', () => {
      drawIntroCard();
      const dataURL = canvas.toDataURL('image/png');
      downloadLink.href = dataURL;
      downloadLink.download = 'self_intro_card.png';
      downloadLink.classList.remove('hidden');
      downloadLink.click();
    });

    // 入力が変わったらプレビュー更新
    [
      'nicknameInput', 'ageSelect', 'ageHidden', 'locationInput', 'locationHidden',
      'hobbyInput', 'gameInput', 'messageInput'
    ].forEach(id => {
      const el = document.getElementById(id);
      el.addEventListener('input', drawIntroCard);
      el.addEventListener('change', drawIntroCard);
    });

    themeSelect.addEventListener('change', () => {
      drawIntroCard();
    });
    color1Input.addEventListener('input', drawIntroCard);
    color2Input.addEventListener('input', drawIntroCard);

    // アイコン位置・スケールのスライダー
    [iconPosXInput, iconPosYInput, iconScaleInput].forEach(el => {
      el.addEventListener('input', () => {
        updateIconLabels();
        drawIntroCard();
      });
    });
  </script>
</body>
</html>
